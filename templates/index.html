<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuNa - Profile/Index</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .gradient-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        .like-button i {
            transition: color 0.3s ease, transform 0.3s ease;
        }
        .like-button:hover i {
            transform: scale(1.2);
        }
        .like-button.liked i {
            color: #e73c7e;
        }
        .post-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Navigation Bar -->
    <nav class="gradient-bg p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-white text-2xl font-bold flex items-center">
                <i class="fas fa-globe mr-2"></i>
                LuNa
            </a>
            <div>
                <a href="/" class="text-white mr-4 hover:text-gray-200 transition duration-300"><i class="fas fa-home mr-1"></i> Home</a>
                <a href="/profile/{{ current_user.username }}" class="text-white mr-4 hover:text-gray-200 transition duration-300"><i class="fas fa-user mr-1"></i> Profile</a>
                <a href="/messages" class="text-white mr-4 hover:text-gray-200 transition duration-300"><i class="fas fa-envelope mr-1"></i> Messages</a>
                <a href="/logout" class="text-white hover:text-gray-200 transition duration-300"><i class="fas fa-sign-out-alt mr-1"></i> Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex container mx-auto mt-8">
        <!-- Sidebar/Profile Info -->
        <div class="w-1/4 pr-4">
            <div class="bg-white shadow rounded-lg p-4 mb-4 post-card">
                <img src="{{ url_for('static', filename='uploads/' + current_user.profile_picture) }}" alt="Profile Picture" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-500">
                <h2 class="text-xl font-bold text-center">{{ current_user.username }}</h2>
                <p class="text-center text-gray-600">{{ current_user.bio }}</p>
                {% if request.endpoint == 'profile' and user != current_user %}
                    {% if current_user.is_following(user) %}
                        <button onclick="toggleFollow('{{ user.username }}')" class="follow-button w-full text-center bg-red-500 text-white py-2 px-4 rounded mt-4 hover:bg-red-600 transition duration-300">
                            <i class="fas fa-user-minus mr-2"></i>Unfollow
                        </button>
                    {% else %}
                        <button onclick="toggleFollow('{{ user.username }}')" class="follow-button w-full text-center bg-blue-500 text-white py-2 px-4 rounded mt-4 hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-user-plus mr-2"></i>Follow
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Posts Section -->
        <div class="w-3/4">
            {% if request.endpoint == 'index' %}
                <form action="{{ url_for('create_post') }}" method="post" enctype="multipart/form-data" class="bg-white shadow rounded-lg p-4 mb-4 post-card">
                    <textarea name="content" rows="3" class="w-full p-2 border rounded" placeholder="What's on your mind?"></textarea>
                    <div class="mt-2 flex justify-between items-center">
                        <label for="media-upload" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded transition duration-300">
                            <i class="fas fa-image mr-2"></i>Add Media
                        </label>
                        <input id="media-upload" type="file" name="media" accept="image/*,video/*" class="hidden">
                        <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-paper-plane mr-2"></i>Post
                        </button>
                    </div>
                </form>
            {% endif %}
            
            {% for post in posts %}
                <div id="post-{{ post.id }}" class="bg-white shadow rounded-lg p-4 mb-4 post-card">
                    <div class="flex items-center mb-2 justify-between">
                        <div class="flex items-center">
                            <img src="{{ url_for('static', filename='uploads/' + post.author.profile_picture) }}" alt="Profile Picture" class="w-10 h-10 rounded-full mr-2">
                            <div>
                                <a href="{{ url_for('profile', username=post.author.username) }}" class="font-bold hover:underline">{{ post.author.username }}</a>
                                <p class="text-gray-500 text-sm">{{ post.timestamp.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            </div>
                        </div>
                        {% if post.author == current_user %}
                            <button onclick="deletePost('{{ post.id }}')" class="text-red-500 hover:text-red-700 transition duration-300">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        {% endif %}
                    </div>
                    <p class="mb-2">{{ post.content }}</p>
                    {% if post.media_url %}
                        <img src="{{ post.media_url }}" alt="Post Media" class="w-full rounded-lg mb-2">
                    {% endif %}
                    <div class="flex items-center">
                        <button class="like-button mr-4 flex items-center" data-post-id="{{ post.id }}">
                            <i class="fas fa-heart mr-1"></i>
                            <span class="like-count">{{ post.likes.count() }}</span> Likes
                        </button>
                        <button class="comment-button flex items-center" onclick="toggleComments('{{ post.id }}')">
                            <i class="fas fa-comment mr-1"></i>
                            <span>{{ post.comments.count() }} Comments</span>
                        </button>
                    </div>
                    <div id="comments-{{ post.id }}" class="hidden mt-4">
                        {% for comment in post.comments %}
                            <div id="comment-{{ comment.id }}" class="bg-gray-100 p-2 rounded mb-2 flex justify-between items-center">
                                <p><strong>{{ comment.author.username }}:</strong> {{ comment.content }}</p>

                                {% if comment.author == current_user %}
                                    <button onclick="deleteComment('{{ comment.id }}', '{{ post.id }}')" class="text-red-500 hover:text-red-700 transition duration-300 text-sm">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                {% endif %}
                            </div>
                        {% endfor %}
                        <form action="{{ url_for('add_comment', post_id=post.id) }}" method="post" class="mt-2 flex">
                            <input type="text" name="content" class="w-full p-2 border rounded-l" placeholder="Add a comment...">
                            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-r hover:bg-blue-600 transition duration-300">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Footer -->
    <footer class="gradient-bg p-4 mt-8 text-white">
        <div class="container mx-auto text-center">
            &copy; 2024 LuNa SocialApp. All rights reserved.
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            anime({
                targets: commentsSection,
                height: commentsSection.classList.contains('hidden') ? [0, commentsSection.scrollHeight] : [commentsSection.scrollHeight, 0],
                duration: 300,
                easing: 'easeInOutQuad',
                begin: function(anim) {
                    if (commentsSection.classList.contains('hidden')) {
                        commentsSection.classList.remove('hidden');
                        commentsSection.style.height = '0px';
                        commentsSection.style.overflow = 'hidden';
                    }
                },
                complete: function(anim) {
                    if (anim.reversed) {
                        commentsSection.classList.add('hidden');
                        commentsSection.style.height = '';
                        commentsSection.style.overflow = '';
                    } else {
                        commentsSection.style.height = '';
                        commentsSection.style.overflow = '';
                    }
                }
            });
        }

        document.querySelectorAll('.like-button').forEach(button => {
            button.addEventListener('click', function() {
                const postId = this.dataset.postId;
                fetch(`/like/${postId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    const likeCount = this.querySelector('.like-count');
                    const icon = this.querySelector('i');
                    if (data.status === 'liked') {
                        likeCount.textContent = (parseInt(likeCount.textContent) || 0) + 1;
                        this.classList.add('liked');
                        anime({
                            targets: icon,
                            scale: [1, 1.5, 1],
                            duration: 300,
                            easing: 'easeInOutQuad'
                        });
                    } else if (data.status === 'unliked') {
                        likeCount.textContent = (parseInt(likeCount.textContent) || 0) - 1;
                        this.classList.remove('liked');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update like count. Please try again.');
                });
            });
        });

        function deletePost(postId) {
            if (confirm('Are you sure you want to delete this post?')) {
                const postElement = document.getElementById(`post-${postId}`);
                anime({
                    targets: postElement,
                    opacity: 0,
                    height: 0,
                    marginBottom: 0,
                    duration: 500,
                    easing: 'easeOutQuad',
                    complete: function() {
                        fetch(`/delete_post/${postId}`, {
                            method: 'POST'
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                postElement.remove();
                            } else {
                                throw new Error(data.message || 'Failed to delete post');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to delete post. Please try again.');
                            anime({
                                targets: postElement,
                                opacity: 1,
                                height: postElement.scrollHeight,
                                marginBottom: '1rem',
                                duration: 500,
                                easing: 'easeOutQuad'
                            });
                        });
                    }
                });
            }
        }

        function deleteComment(commentId, postId) {
            if (confirm('Are you sure you want to delete this comment?')) {
                const commentElement = document.getElementById(`comment-${commentId}`);
                anime({
                    targets: commentElement,
                    opacity: 0,
                    height: 0,
                    marginBottom: 0,
                    duration: 300,
                    easing: 'easeOutQuad',
                    complete: function() {
                        fetch(`/delete_comment/${commentId}`, {
                            method: 'POST'
                        })
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                const commentsSection = document.getElementById(`comments-${postId}`);
                                commentElement.remove();
                                if (commentsSection.querySelectorAll('.comment').length === 0) {
                                    commentsSection.classList.add('hidden');
                                }
                            } else {
                                throw new Error(data.message || 'Failed to delete comment');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to delete comment. Please try again.');
                            anime({
                                targets: commentElement,
                                opacity: 1,
                                height: commentElement.scrollHeight,
                                marginBottom: '0.5rem',
                                duration: 300,
                                easing: 'easeOutQuad'
                            });
                        });
                    }
                });
            }
        }

        function toggleFollow(username) {
            const followButton = document.querySelector('.follow-button');
            const currentAction = followButton.textContent.trim().toLowerCase();
            const newAction = currentAction === 'follow' ? 'unfollow' : 'follow';
            const url = `/${newAction}/${username}`;

            fetch(url, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        followButton.innerHTML = newAction === 'follow' 
                            ? '<i class="fas fa-user-plus mr-2"></i>Follow'
                            : '<i class="fas fa-user-minus mr-2"></i>Unfollow';
                        followButton.classList.toggle('bg-blue-500');
                        followButton.classList.toggle('bg-red-500');
                        followButton.classList.toggle('hover:bg-blue-600');
                        followButton.classList.toggle('hover:bg-red-600');

                        anime({
                            targets: followButton,
                            scale: [1, 1.1, 1],
                            duration: 300,
                            easing: 'easeInOutQuad'
                        });
                    } else {
                        throw new Error(data.message || 'Failed to update follow status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to update follow status. Please try again.');
                });
        }

        // Add smooth scrolling to top when clicking on logo
        document.querySelector('nav a').addEventListener('click', function(e) {
            if (this.getAttribute('href') === '/') {
                e.preventDefault();
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }
        });

        // Animate post cards on page load
        anime({
            targets: '.post-card',
            opacity: [0, 1],
            translateY: [50, 0],
            delay: anime.stagger(100),
            easing: 'easeOutQuad',
            duration: 500
        });

        // Add hover effect to nav links
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('mouseenter', function() {
                anime({
                    targets: this,
                    translateY: -3,
                    duration: 200,
                    easing: 'easeOutQuad'
                });
            });
            link.addEventListener('mouseleave', function() {
                anime({
                    targets: this,
                    translateY: 0,
                    duration: 200,
                    easing: 'easeOutQuad'
                });
            });
        });

        // Initialize tooltips
        tippy('[data-tippy-content]', {
            theme: 'light-border',
            animation: 'scale'
        });
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        socket.on('connect', function() {
            console.log('Connected to the server');
        });

        socket.on('vulgar_warning', function(data) {
            alert(data.message);
        });

        function submitContent(content) {
            fetch('/submit_content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Moderation result:', data);
            })
            .catch(error => {
                console.error('Error submitting content:', error);
            });
        }
    </script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
</body>
</html>