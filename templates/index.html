<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuNa - Profile/Index</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='Luna-icon.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .gradient-bg {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        .user-initial {
            width: 2.5rem;
            height: 2.5rem;
            background-color: #3B82F6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50%;
        }
        .post-card {
            transition: all 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <nav class="gradient-bg p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-white text-2xl font-bold flex items-center">
                <i class="fas fa-globe mr-2"></i>
                LuNa
            </a>
            <button id="menu-toggle" class="text-white text-2xl md:hidden">
                <i class="fas fa-bars"></i>
            </button>
            <div id="menu" class="hidden md:flex space-x-4">
                <a href="/" class="text-white hover:text-gray-200 transition duration-300"><i class="fas fa-home mr-1"></i> Home</a>
                <a href="/profile/{{ current_user.username }}" class="text-white hover:text-gray-200 transition duration-300"><i class="fas fa-user mr-1"></i> Profile</a>
                <a href="/messages" class="text-white hover:text-gray-200 transition duration-300"><i class="fas fa-envelope mr-1"></i> Messages</a>
                <a href="/notifications" class="text-white hover:text-gray-200 transition duration-300"><i class="fa-solid fa-bell"></i> Notifications</a>
                <a href="/logout" class="text-white hover:text-gray-200 transition duration-300"><i class="fas fa-sign-out-alt mr-1"></i> Logout</a>
            </div>
        </div>
        <div id="dropdown-menu" class="md:hidden hidden bg-gray-800 text-white absolute w-full mt-2 rounded-lg shadow-lg">
            <a href="/" class="block px-4 py-2 hover:bg-gray-700 transition duration-300"><i class="fas fa-home mr-1"></i> Home</a>
            <a href="/profile/{{ current_user.username }}" class="block px-4 py-2 hover:bg-gray-700 transition duration-300"><i class="fas fa-user mr-1"></i> Profile</a>
            <a href="/messages" class="block px-4 py-2 hover:bg-gray-700 transition duration-300"><i class="fas fa-envelope mr-1"></i> Messages</a>
            <a href="/notifications" class="block px-4 py-2 hover:bg-gray-700 transition duration-300"><i class="fa-solid fa-bell"></i> Notifications</a>
            <a href="/logout" class="block px-4 py-2 hover:bg-gray-700 transition duration-300"><i class="fas fa-sign-out-alt mr-1"></i> Logout</a>
        </div>
    </nav>

    <main class="flex-grow container mx-auto mt-4 px-4">
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            {% for user in all_users %}
                <a href="{{ url_for('user_profile', username=user.username) }}" class="flex flex-col items-center">
                    {% if user.profile_picture %}
                        <img src="{{ url_for('static', filename='uploads/' + user.profile_picture) }}" alt="{{ user.username }}" class="w-12 h-12 rounded-full">
                    {% else %}
                        <div class="user-initial">
                            {{ user.username[0].upper() }}
                        </div>
                    {% endif %}
                    <span class="text-sm mt-1">{{ user.username }}</span>
                </a>
            {% endfor %}
        </div>
    
        <div class="flex flex-col sm:flex-row">
            <div class="w-full sm:w-1/4 pr-0 sm:pr-4 mb-4 sm:mb-0">
                <div class="bg-white shadow rounded-lg p-4 mb-4 post-card">
                    {% if current_user.is_authenticated %}
                        {% if current_user.profile_picture %}
                            <img src="{{ url_for('static', filename='uploads/' + current_user.profile_picture) }}" alt="Profile Picture" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-500">
                        {% else %}
                            <div class="user-initial w-32 h-32 mx-auto mb-4 border-4 border-blue-500 text-5xl flex items-center justify-center">
                                {{ current_user.username[0].upper() }}
                            </div>
                        {% endif %}
                        <h2 class="text-xl font-bold text-center">{{ current_user.username }}</h2>
                        <p class="text-center mt-2">{{ current_user.bio }}</p>
                    {% else %}
                        <p class="text-center">Please <a href="{{ url_for('login') }}" class="text-blue-500 hover:underline">log in</a> to see your profile.</p>
                    {% endif %}
                </div>
            </div>
    
            <div class="w-full sm:w-3/4">
                {% if current_user.is_authenticated %}
                    <div id="post-form" class="bg-white shadow rounded-lg p-4 mb-4">
                        <form id="create-post-form" action="{{ url_for('post') }}" method="post" enctype="multipart/form-data">
                            <textarea id="post-content" name="content" placeholder="What's on your mind?" class="w-full p-2 border rounded mb-2" rows="3">{{ original_content if original_content else '' }}</textarea>
                            <div id="ai-suggestions" class="mb-4 p-3 bg-yellow-100 border border-yellow-400 rounded {{ 'hidden' if not ai_response else '' }}">
                                <p>{{ ai_response['explanation'] }}</p>
                                <ul id="ai-suggestion-list">
                                    {% if ai_response %}
                                        {% for suggestion in ai_response['suggestions'] %}
                                            <li class="text-yellow-700 cursor-pointer hover:text-yellow-800">{{ suggestion }}</li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <input type="file" name="media" id="media" class="hidden" accept="image/*,video/*">
                                <label for="media" class="btn btn-primary flex items-center space-x-2 py-2 px-4 rounded bg-blue-600 hover:bg-blue-700 transition duration-300 cursor-pointer">
                                    <i class="fas fa-image"></i>
                                    <span>Add Media</span>
                                </label>
                                <a href="https://content-gen-kw4y.onrender.com" target="_blank" class="btn btn-secondary flex items-center space-x-2 py-2 px-4 rounded border-transparent bg-purple-600 hover:bg-purple-700 transition duration-300">
                                    <i class="fa-brands fa-bots"></i>
                                    Content Generator
                                </a>
                                <button type="submit" class="btn btn-primary flex items-center space-x-2 py-2 px-4 rounded bg-blue-500 hover:bg-green-700 transition duration-300">
                                    <i class="fas fa-paper-plane"></i>
                                    Post
                                </button>
                            </div>
                        </form>
                    </div>
                {% endif %}
    
                {% for post in all_posts %}
                    <div id="post-{{ post.id }}" class="bg-white shadow rounded-lg p-4 mb-4 post-card">
                        <div class="flex items-center mb-2 justify-between">
                            <div class="flex items-center">
                                {% if post.author.profile_picture %}
                                    <img src="{{ url_for('static', filename='uploads/' + post.author.profile_picture) }}" alt="Profile Picture" class="w-10 h-10 rounded-full mr-2">
                                {% else %}
                                    <div class="user-initial mr-2">
                                        {{ post.author.username[0].upper() }}
                                    </div>
                                {% endif %}
                                <div>
                                    <a href="{{ url_for('user_profile', username=post.author.username) }}" class="font-bold hover:underline">@{{ post.author.username }}</a>
                                    <p class="text-sm text-gray-500">{{ post.timestamp.strftime('%B %d, %Y at %I:%M %p') }}</p>
                                </div>
                            </div>
                            {% if post.author == current_user %}
                                <button class="text-red-500 hover:text-red-700" onclick="deletePost({{ post.id }})">Delete</button>
                            {% endif %}
                        </div>
                        <p class="mb-2">{{ post.content | replace_usernames | safe }}</p>
                        {% if post.media_url %}
                            {% if post.media_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                                <img src="{{ url_for('static', filename='uploads/' + post.media_url) }}" alt="Post Media" class="w-full rounded-lg mb-2">
                            {% elif post.media_url.lower().endswith(('.mp4', '.webm', '.ogg')) %}
                                <video src="{{ url_for('static', filename='uploads/' + post.media_url) }}" controls class="w-full rounded-lg mb-2"></video>
                            {% endif %}
                        {% endif %}
                        <div class="flex items-center space-x-2">
                            <button class="text-blue-500 hover:text-blue-700" onclick="likePost({{ post.id }})">Like <span id="like-count-{{ post.id }}">{{ post.likes_count }}</span></button>
                            <button class="text-gray-500 hover:text-gray-700">Comment</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </main>
    
    

    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="container mx-auto text-center">
            © 2024 LuNa. All rights reserved.
        </div>
    </footer>

    <script>
        
        document.addEventListener('DOMContentLoaded', function () {
            const createPostForm = document.getElementById('create-post-form');
            const postContent = document.getElementById('post-content');
            const aiSuggestions = document.getElementById('ai-suggestions');
            const aiExplanation = document.getElementById('ai-explanation');
            const aiSuggestionList = document.getElementById('ai-suggestion-list');
        
            // Function to handle form submission
            createPostForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
        
                fetch('/post', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    // Handle redirection if returned from server
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.violates_guidelines) {
                        aiExplanation.textContent = data.explanation;
                        aiSuggestionList.innerHTML = '';
                        data.suggestions.forEach(suggestion => {
                            const li = document.createElement('li');
                            li.className = 'text-yellow-700 cursor-pointer hover:text-yellow-800';
                            li.textContent = suggestion;
                            li.onclick = function() {
                                postContent.value = suggestion;
                                aiSuggestions.classList.add('hidden');
                            };
                            aiSuggestionList.appendChild(li);
                        });
                        aiSuggestions.classList.remove('hidden');
                    } else {
                        // Post was successful, refresh the page or update the posts list
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while processing your post. Please try again.');
                });
            });
        
            // Function to handle "like" button clicks
            window.likePost = function(postId) {
                fetch(`/like/${postId}`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById(`like-count-${postId}`).textContent = data.likes_count;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while liking the post. Please try again.');
                    });
            };
        
            // Function to handle "delete" button clicks
            window.deletePost = function(postId) {
                if (confirm('Are you sure you want to delete this post?')) {
                    fetch(`/delete_post/${postId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                document.getElementById(`post-${postId}`).remove();
                            } else {
                                alert('An error occurred while deleting the post. Please try again.');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while deleting the post. Please try again.');
                        });
                }
            };
        });
        
        </script>
        
    
</body>
</html>